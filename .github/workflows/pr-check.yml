name: Pull Request Validation

on:
  pull_request:
    branches:
      - master
      - main

jobs:
  validate-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for version comparison

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check version bump
        run: |
          echo "Checking if version was bumped..."

          # Get version from PR branch
          PR_VERSION=$(node -p "require('./package.json').version")
          echo "PR version: $PR_VERSION"

          # Get version from base branch (master/main)
          git fetch origin ${{ github.base_ref }}
          BASE_VERSION=$(git show origin/${{ github.base_ref }}:package.json | node -p "JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf8')).version")
          echo "Base version: $BASE_VERSION"

          if [ "$PR_VERSION" = "$BASE_VERSION" ]; then
            echo "‚ùå ERROR: Version not bumped!"
            echo ""
            echo "The package.json version is the same as the base branch."
            echo "Please bump the version using one of:"
            echo "  npm run version:patch  (bug fixes)"
            echo "  npm run version:minor  (new features)"
            echo "  npm run version:major  (breaking changes)"
            echo ""
            exit 1
          else
            echo "‚úÖ Version bumped: $BASE_VERSION ‚Üí $PR_VERSION"
          fi

      - name: Check CHANGELOG.md updated
        run: |
          echo "Checking if CHANGELOG.md was updated..."

          # Check if CHANGELOG.md was modified in this PR
          git fetch origin ${{ github.base_ref }}
          CHANGELOG_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep "^CHANGELOG.md$" || echo "")

          if [ -z "$CHANGELOG_CHANGED" ]; then
            echo "‚ùå ERROR: CHANGELOG.md was not updated!"
            echo ""
            echo "Please update CHANGELOG.md with details about this release."
            echo "Document what changed, why, and any breaking changes."
            echo ""
            exit 1
          else
            echo "‚úÖ CHANGELOG.md was updated"
          fi

      - name: Check artifact checksums
        run: |
          echo "Checking artifact checksums..."
          node scripts/check-artifact-changes.js

      - name: Validate package
        run: |
          echo "Validating package structure..."
          npm pack --dry-run

      - name: Summary
        run: |
          echo "‚úÖ Pull request validation passed!"
          echo "üì¶ Ready for merge to ${{ github.base_ref }}"
          echo ""
          PR_VERSION=$(node -p "require('./package.json').version")
          echo "Version: $PR_VERSION"
